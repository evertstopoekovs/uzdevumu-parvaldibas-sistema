import json
from typing import List, Optional

#  Statusi
VALID_STATUSES = ["Jauns", "Procesā", "Pabeigts", "Atlikts"]


class Uzdevums:
    def __init__(self, id: int, nosaukums: str, status: str = "Jauns"):
        self.id = id
        self.nosaukums = nosaukums
        self.status = status

    def set_status(self, new_status: str):
        if new_status not in VALID_STATUSES:
            raise ValueError(f"Nederīgs statuss: {new_status}")
        self.status = new_status

    def to_dict(self):
        return {"id": self.id, "nosaukums": self.nosaukums, "status": self.status}


    def from_dict(cls, data):
        return cls(data["id"], data["nosaukums"], data["status"])

    def __str__(self):
        return f"[{self.id}] {self.nosaukums} ({self.status})"


class UzdevumuSaraksts:
    def __init__(self):
        self.uzdevumi: List[Uzdevums] = []

    def add(self, uzdevums: Uzdevums):
        self.uzdevumi.append(uzdevums)

    def get_by_id(self, id: int) -> Optional[Uzdevums]:
        for u in self.uzdevumi:
            if u.id == id:
                return u
        return None

    def delete(self, id: int):
        self.uzdevumi = [u for u in self.uzdevumi if u.id != id]

    def filter_by_status(self, status: str):
        return [u for u in self.uzdevumi if u.status == status]

    def search_by_name(self, term: str):
        term = term.lower()
        return [u for u in self.uzdevumi if term in u.nosaukums.lower()]

    def sort_by_id(self):
        self.uzdevumi.sort(key=lambda u: u.id)

    def sort_by_name(self):
        self.uzdevumi.sort(key=lambda u: u.nosaukums.lower())

    def saglabat_faila(self, filename: str):
        with open(filename, "w", encoding="utf-8") as f:
            json.dump([u.to_dict() for u in self.uzdevumi], f, ensure_ascii=False, indent=4)

    def ieladet_no_faila(self, filename: str):
        try:
            with open(filename, "r", encoding="utf-8") as f:
                data = json.load(f)
            self.uzdevumi = [Uzdevums.from_dict(d) for d in data]
        except FileNotFoundError:
            print(f"Fails '{filename}' neeksistē!")
        except json.JSONDecodeError:
            print(f"Fails '{filename}' nav derīgs JSON!")


def menu():
    print("""


def get_int(prompt: str):
    try:
        return int(input(prompt))
    except ValueError:
        print("‼ Lūdzu ievadi skaitli!")
        return None


def main():
    uzs = UzdevumuSaraksts()
    next_id = 1

    while True:
        menu()
        choice = input("Izvēle: ")

        if choice == "1":
            name = input("Nosaukums: ").strip()
            if name:
                uzs.add(Uzdevums(next_id, name))
                next_id += 1
                print(" Uzdevums pievienots!")
            else:
                print("‼ Nosaukums nevar būt tukšs.")

        elif choice == "2":
            if not uzs.uzdevumi:
                print(" Nav neviena uzdevuma.")
            for u in uzs.uzdevumi:
                print(u)

        elif choice == "3":
            idn = get_int("Ievadi ID: ")
            if idn is None:
                continue
            u = uzs.get_by_id(idn)
            if u:
                print("Pieejamie statusi:", VALID_STATUSES)
                new_stat = input("Jaunais statuss: ")
                try:
                    u.set_status(new_stat)
                    print(" Statuss nomainīts!")
                except ValueError as e:
                    print("‼", e)
            else:
                print("‼ Nav tāda uzdevuma ar šo ID.")

        elif choice == "4":
            idn = get_int("Ievadi ID, ko dzēst: ")
            if idn is None:
                continue
            uzs.delete(idn)
            print("✔ Dzēsts (ja tāds bija).")

        elif choice == "5":
            idn = get_int("Ievadi ID: ")
            if idn is None:
                continue
            u = uzs.get_by_id(idn)
            print(u if u else "‼ Nav tāda uzdevuma.")

        elif choice == "6":
            status = input("Statuss: ")
            rezultati = uzs.filter_by_status(status)
            for u in rezultati:
                print(u)
            if not rezultati:
                print("‼ Nav uzdevumu ar tādu statusu.")

        elif choice == "7":
            term = input("Meklēt pēc vārda: ")
            rezultati = uzs.search_by_name(term)
            for u in rezultati:
                print(u)
            if not rezultati:
                print("‼ Nekas netika atrasts.")

        elif choice == "8":
            fn = input("Faila nosaukums: ")
            uzs.saglabat_faila(fn)
            print("  Saglabāts!")

        elif choice == "9":
            fn = input("Faila nosaukums: ")
            uzs.ieladet_no_faila(fn)

        elif choice == "0":
            print(" Tiekamies vēl!")
            break

        else:
            print("‼ Nepazīstama izvēle!")


if __name__ == "__main__":
    main()
